name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Get Python Version
      id: get_version
      run: |
        python_version=$(python scripts/get_python_version.py | jq -r .full)
        echo "version=${python_version}" >> $GITHUB_OUTPUT

    # Docker 로그인
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 이미지 빌드 및 푸시
    - name: Build and push image
      run: |
        docker build \
        --build-arg PYTHON_VERSION=${{ steps.get_version.outputs.version }} \
        -t ${{ secrets.DOCKERHUB_USERNAME }}/milkyway_bot:${{ github.sha }} \
        -t ${{ secrets.DOCKERHUB_USERNAME }}/milkyway_bot:latest .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/milkyway_bot:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/milkyway_bot:latest
        
    # 개인 서버에 배포
    - name: Deploy to Ubuntu Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 3224
        script: |
            cd /app/milkywayBot
            git pull origin main
            docker-compose pull
            docker-compose down
            docker-compose up -d --force-recreate
            sleep 10